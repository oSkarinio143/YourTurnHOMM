<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Panel pojedynków - YourTurnHOMM</title>
  <style th:nonce="${cspNonce}">
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #6c757d 0%, #495057 50%, #868e96 100%);
      font-family: 'Arial', sans-serif;
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 80%, rgba(108, 117, 125, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(134, 142, 150, 0.1) 0%, transparent 50%), radial-gradient(circle at 40% 40%, rgba(173, 181, 189, 0.05) 0%, transparent 50%);
      animation: backgroundShift 20s ease-in-out infinite;
      z-index: -2;
    }
    @keyframes backgroundShift {
      0%, 100% { transform: translate(0); }
      33% { transform: translate(-20px, 10px); }
      66% { transform: translate(20px, -10px); }
    }
    .floating-elements {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      z-index: -1;
    }
    .floating-element {
      position: absolute;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 50%;
      animation: float 15s infinite linear;
    }
    .floating-element:nth-child(1) { width: 80px; height: 80px; top: 10%; left: 10%; animation-delay: 0s; }
    .floating-element:nth-child(2) { width: 120px; height: 120px; top: 70%; left: 80%; animation-delay: -5s; }
    .floating-element:nth-child(3) { width: 60px; height: 60px; top: 40%; left: 90%; animation-delay: -10s; }
    .floating-element:nth-child(4) { width: 100px; height: 100px; top: 20%; left: 70%; animation-delay: -3s; }
    .floating-element:nth-child(5) { width: 90px; height: 90px; top: 80%; left: 20%; animation-delay: -8s; }
    @keyframes float {
      0% { transform: translateY(100vh) rotate(0); opacity: 0; }
      10%, 90% { opacity: 1; }
      100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
    }
    .main-container { max-width: 1400px; margin: 20px auto; position: relative; z-index: 10; }
    h1 { text-align: center; font-size: 38px; font-weight: bold; margin-bottom: 40px; color: #fff; text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
    .battle-arena { display: flex; gap: 20px; align-items: center; justify-content: center; }
    .main-battle-section {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 40px;
      min-height: 500px;
      display: grid;
      grid-template-columns: 1fr 1.5fr 1fr;
      gap: 20px;
      align-items: start;
      flex: 1;
    }
    .hero-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 25px 20px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(15px);
      width: 220px;
      height: 380px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      border: 1px solid;
      transition: all 0.3s ease;
    }
    .hero-section:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2); }
    .hero-section.left-hero { border-color: rgba(30, 136, 229, 0.3); }
    .hero-section.right-hero { border-color: rgba(229, 57, 53, 0.3); }
    .hero-title { font-size: 18px; font-weight: bold; color: #333; text-align: center; margin-bottom: 15px; }
    .stat-group, .quantity-section { width: 100%; display: flex; flex-direction: column; gap: 8px; }
    .stat-label, .quantity-label { font-size: 14px; font-weight: 600; color: #333; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-input, .quantity-input { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; font-weight: bold; text-align: center; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.8); }
    .stat-input:focus, .quantity-input:focus { outline: none; transform: translateY(-2px); background: rgba(255, 255, 255, 0.95); }
    .left-hero .stat-input:focus, .left-army .quantity-input:focus { border-color: #1e88e5; box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1), 0 5px 15px rgba(30, 136, 229, 0.2); }
    .right-hero .stat-input:focus, .right-army .quantity-input:focus { border-color: #e53935; box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.1), 0 5px 15px rgba(229, 57, 53, 0.2); }
    .army-section { display: flex; flex-direction: column; align-items: center; gap: 20px; position: relative; min-height: 420px; }
    .army-title { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 10px; }
    .styled-button {
      display: block;
      width: 100%;
      padding: 15px;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      text-decoration: none;
      text-align: center;
    }
    .styled-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); transition: left 0.5s; }
    .styled-button:hover { transform: translateY(-2px); }
    .styled-button:hover::before { left: 100%; }
    .select-unit-btn { background: linear-gradient(45deg, #1e88e5, #1565c0); }
    .select-unit-btn:hover { background: linear-gradient(45deg, #1565c0, #0d47a1); box-shadow: 0 8px 25px rgba(30, 136, 229, 0.4); }
    .right-army .select-unit-btn { background: linear-gradient(45deg, #e53935, #c62828); }
    .right-army .select-unit-btn:hover { background: linear-gradient(45deg, #c62828, #b71c1c); box-shadow: 0 8px 25px rgba(229, 57, 53, 0.4); }
    .nav-button-container { position: absolute; bottom: 0; left: 0; right: 0; }
    .back-btn { background: linear-gradient(45deg, #6c757d, #495057); }
    .back-btn:hover { background: linear-gradient(45deg, #495057, #343a40); box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3); }
    .battle-btn { background: linear-gradient(45deg, #ff6b35, #f7b733); }
    .battle-btn:hover { background: linear-gradient(45deg, #e55a2b, #ff8e53); box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4); }
    .battle-btn:disabled { background: #b0bec5; cursor: not-allowed; box-shadow: none; transform: none; }
    .battle-btn:disabled:hover::before { display: none; }
    .battle-center { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; min-height: 400px; }
    .unit-display-container { display: flex; align-items: center; gap: 20px; width: 100%; justify-content: center; }
    .unit-display { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 15px; border-radius: 12px; min-height: 200px; width: 150px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.5); border: 2px dashed; }
    .unit-display.left-unit { border-color: #1e88e5; }
    .unit-display.right-unit { border-color: #e53935; }
    .unit-placeholder { font-size: 64px; font-weight: bold; opacity: 0.5; }
    .left-unit .unit-placeholder { color: #1e88e5; }
    .right-unit .unit-placeholder { color: #e53935; }
    .vs-text { font-size: 48px; font-weight: bold; color: #333; text-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 0 15px; }
    .unit-info { font-size: 14px; font-weight: 600; color: #333; margin-top: 10px; }
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transform: scale(1.1);
      transition: visibility 0s linear 0.25s, opacity 0.25s 0s, transform 0.25s;
    }
    .modal-overlay.show { opacity: 1; visibility: visible; transform: scale(1); transition: visibility 0s linear 0s, opacity 0.25s 0s, transform 0.25s; }
    .modal-container {
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      backdrop-filter: blur(20px);
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25), 0 8px 20px rgba(220, 53, 69, 0.2);
      border: 1px solid rgba(220, 53, 69, 0.25);
      padding: 30px;
      width: 100%;
      max-width: 450px;
      position: relative;
      transform: translateY(20px);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .modal-overlay.show .modal-container { transform: translateY(0); }
    .modal-header { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 10px; }
    .modal-icon { width: 40px; height: 40px; background: linear-gradient(45deg, #dc3545, #c82333); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .modal-title { font-size: 20px; font-weight: bold; color: #dc3545; margin: 0; }
    .modal-content { text-align: center; margin-bottom: 25px; }
    .modal-message { font-size: 16px; color: #495057; line-height: 1.5; margin: 0; }
    .modal-actions { display: flex; justify-content: center; }
    .modal-button { padding: 12px 30px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
    .modal-button-primary { background: linear-gradient(45deg, #dc3545, #c82333); color: white; box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3); }
    .modal-button-primary:hover { background: linear-gradient(45deg, #c82333, #bd2130); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(220, 53, 69, 0.4); }
    .modal-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; color: #6c757d; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
    .modal-close:hover { background: rgba(220, 53, 69, 0.1); color: #dc3545; transform: rotate(90deg); }
    .modal-progress { position: absolute; bottom: 0; left: 0; height: 4px; background: linear-gradient(45deg, #dc3545, #c82333); border-radius: 0 0 12px 12px; width: 100%; transform-origin: left; animation: progressShrink 5s linear forwards; }
    .unitImg { max-width:180px; max-height:180px; }
    @keyframes progressShrink { from { transform: scaleX(1); } to { transform: scaleX(0); } }
  </style>
</head>
<body>

<div class="floating-elements">
  <div class="floating-element"></div>
  <div class="floating-element"></div>
  <div class="floating-element"></div>
  <div class="floating-element"></div>
  <div class="floating-element"></div>
</div>

<div class="main-container">
  <h1>Panel pojedynków</h1>
  <div class="battle-arena">
    <div class="hero-section left-hero">
      <div class="hero-title">Statystyki bohatera gracza</div>
      <div class="stat-group">
        <label class="stat-label">Atak:</label>
        <input type="number" class="stat-input" id="leftHeroAttack" min="0" placeholder="0" th:value="${duelForm.leftHeroAttack}">
      </div>
      <div class="stat-group">
        <label class="stat-label">Obrona:</label>
        <input type="number" class="stat-input" id="leftHeroDefense" min="0" placeholder="0" th:value="${duelForm.leftHeroDefense}">
      </div>
    </div>

    <div class="main-battle-section">
      <div class="army-section left-army">
        <div class="army-title">Gracz</div>
        <div class="unit-selector">
          <form th:action="@{/oskarinio143/YourTurnHOMM/user/duel/select}" method="get" id="selectLeftForm">
            <input type="hidden" name="side" value="LEFT">
            <input type="hidden" name="leftUnit" th:value="${duelForm.leftUnit?.name}">
            <input type="hidden" name="rightUnit" th:value="${duelForm.rightUnit?.name}">
            <input type="hidden" name="leftHeroAttack">
            <input type="hidden" name="leftHeroDefense">
            <input type="hidden" name="rightHeroAttack">
            <input type="hidden" name="rightHeroDefense">
            <input type="hidden" name="leftQuantity">
            <input type="hidden" name="rightQuantity">
            <button type="submit" class="styled-button select-unit-btn">
              <span th:text="${duelForm.leftUnit == null ? 'Wybierz jednostkę' : 'Zmień jednostkę'}"></span>
            </button>
          </form>
        </div>
        <div class="quantity-section">
          <label class="quantity-label">Podaj ilość:</label>
          <input type="number" class="quantity-input" id="leftQuantity" min="1" placeholder="1" th:value="${duelForm.leftQuantity}">
        </div>
        <div class="nav-button-container">
          <a th:href="@{/oskarinio143/YourTurnHOMM}" class="styled-button back-btn">Wróć do bazy</a>
        </div>
      </div>

      <div class="battle-center">
        <div class="unit-display-container">
          <div class="unit-display left-unit">
            <div th:if="${duelForm.leftUnit}">
              <img th:src="@{${duelForm.leftUnit.imagePath}}" alt="Left Unit Image" class="unitImg">
              <div class="unit-info" th:text="${duelForm.leftUnit.name}"></div>
            </div>
            <div th:unless="${duelForm.leftUnit}" class="unit-placeholder">?</div>
          </div>
          <div class="vs-text">VS</div>
          <div class="unit-display right-unit">
            <div th:if="${duelForm.rightUnit}">
              <img th:src="@{${duelForm.rightUnit.imagePath}}" alt="Right Unit Image" class="unitImg">
              <div class="unit-info" th:text="${duelForm.rightUnit.name}"></div>
            </div>
            <div th:unless="${duelForm.rightUnit}" class="unit-placeholder">?</div>
          </div>
        </div>
      </div>

      <div class="army-section right-army">
        <div class="army-title">Przeciwnik</div>
        <div class="unit-selector">
          <form th:action="@{/oskarinio143/YourTurnHOMM/user/duel/select}" method="get" id="selectRightForm">
            <input type="hidden" name="side" value="RIGHT">
            <input type="hidden" name="leftUnit" th:value="${duelForm.leftUnit?.name}">
            <input type="hidden" name="rightUnit" th:value="${duelForm.rightUnit?.name}">
            <input type="hidden" name="leftHeroAttack">
            <input type="hidden" name="leftHeroDefense">
            <input type="hidden" name="rightHeroAttack">
            <input type="hidden" name="rightHeroDefense">
            <input type="hidden" name="leftQuantity">
            <input type="hidden" name="rightQuantity">
            <button type="submit" class="styled-button select-unit-btn">
              <span th:text="${duelForm.rightUnit == null ? 'Wybierz jednostkę' : 'Zmień jednostkę'}"></span>
            </button>
          </form>
        </div>
        <div class="quantity-section">
          <label class="quantity-label">Podaj ilość:</label>
          <input type="number" class="quantity-input" id="rightQuantity" min="1" placeholder="1" th:value="${duelForm.rightQuantity}">
        </div>
        <div class="nav-button-container">
          <form th:action="@{/oskarinio143/YourTurnHOMM/user/duel/battle}" method="post" id="battleForm">
            <input type="hidden" name="leftUnit" th:value="${duelForm.leftUnit?.name}">
            <input type="hidden" name="rightUnit" th:value="${duelForm.rightUnit?.name}">
            <input type="hidden" name="leftQuantity">
            <input type="hidden" name="rightQuantity">
            <input type="hidden" name="leftHeroAttack">
            <input type="hidden" name="leftHeroDefense">
            <input type="hidden" name="rightHeroAttack">
            <input type="hidden" name="rightHeroDefense">
            <button type="submit" class="styled-button battle-btn" id="battleButton" th:disabled="${duelForm.leftUnit == null || duelForm.rightUnit == null}">
              Pojedynek ⚔️
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="hero-section right-hero">
      <div class="hero-title">Statystyki bohatera przeciwnika</div>
      <div class="stat-group">
        <label class="stat-label">Atak:</label>
        <input type="number" class="stat-input" id="rightHeroAttack" min="0" placeholder="0" th:value="${duelForm.rightHeroAttack}">
      </div>
      <div class="stat-group">
        <label class="stat-label">Obrona:</label>
        <input type="number" class="stat-input" id="rightHeroDefense" min="0" placeholder="0" th:value="${duelForm.rightHeroDefense}">
      </div>
    </div>
  </div>

  <div id="incorrectValueModal" class="modal-overlay">
    <div class="modal-container">
      <button class="modal-close">×</button>
      <div class="modal-header">
        <div class="modal-icon">⚠️</div>
        <h2 class="modal-title">Nieprawidłowe dane</h2>
      </div>
      <div class="modal-content">
        <p class="modal-message" th:if="${incorrectMessage}" th:utext="${incorrectMessage}"></p>
      </div>
      <div class="modal-actions">
        <button class="modal-button modal-button-primary">Rozumiem</button>
      </div>
      <div class="modal-progress"></div>
    </div>
  </div>
</div>

<script th:nonce="${cspNonce}" th:inline="javascript">
  /*<![CDATA[*/
  document.addEventListener('DOMContentLoaded', () => {
    const incorrectMessage = /*[[${incorrectMessage}]]*/ null;

    const forms = {
      selectLeft: document.getElementById('selectLeftForm'),
      selectRight: document.getElementById('selectRightForm'),
      battle: document.getElementById('battleForm')
    };

    const visibleInputs = {
      leftQuantity: document.getElementById('leftQuantity'),
      rightQuantity: document.getElementById('rightQuantity'),
      leftHeroAttack: document.getElementById('leftHeroAttack'),
      leftHeroDefense: document.getElementById('leftHeroDefense'),
      rightHeroAttack: document.getElementById('rightHeroAttack'),
      rightHeroDefense: document.getElementById('rightHeroDefense')
    };

    const battleButton = document.getElementById('battleButton');

    function syncVisibleInputsToForm(form) {
      if (!form) return;
      for (const key in visibleInputs) {
        const hiddenInput = form.querySelector(`input[name="${key}"]`);
        if (hiddenInput) {
          hiddenInput.value = visibleInputs[key].value || 0;
        }
      }
    }

    Object.values(forms).forEach(form => {
      if (form) {
        form.addEventListener('submit', (e) => {
          if (form.id === 'battleForm' && battleButton.disabled) {
            e.preventDefault();
            return;
          }
          syncVisibleInputsToForm(form);
        });
      }
    });

    const modal = document.getElementById('incorrectValueModal');
    if (modal) {
      const closeModal = () => {
        modal.classList.remove('show');
        setTimeout(() => { modal.style.display = 'none'; }, 250);
      };

      const showModal = () => {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
        const timeoutId = setTimeout(closeModal, 5000);

        const cleanup = () => {
          clearTimeout(timeoutId);
          closeModal();
          modal.removeEventListener('click', clickHandler);
          document.removeEventListener('keydown', keydownHandler);
        };

        const clickHandler = (e) => {
          if (e.target === modal || e.target.closest('.modal-close, .modal-button')) {
            cleanup();
          }
        };

        const keydownHandler = (e) => {
          if (e.key === 'Escape' && modal.classList.contains('show')) {
            cleanup();
          }
        };

        modal.addEventListener('click', clickHandler);
        document.addEventListener('keydown', keydownHandler);
      };

      if (incorrectMessage) {
        showModal();
      }
    }
  });
  /*]]>*/
</script>

</body>
</html>